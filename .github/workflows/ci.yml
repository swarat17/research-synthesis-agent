name: CI

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]

jobs:
  # ── Job 1: Lint ────────────────────────────────────────────────────────
  lint:
    name: Lint (ruff + black)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install linters
        run: pip install ruff==0.15.4 black==26.1.0

      - name: ruff check
        run: ruff check src/ tests/

      - name: black check
        run: black --check src/ tests/

  # ── Job 2: Unit tests ──────────────────────────────────────────────────
  unit-tests:
    name: Unit tests + coverage
    needs: lint
    runs-on: ubuntu-latest
    env:
      # Dummy values — prevent import-time failures, no real calls made
      OPENAI_API_KEY: "sk-dummy"
      ANTHROPIC_API_KEY: "sk-ant-dummy"
      PINECONE_API_KEY: "dummy"
      PINECONE_INDEX: "dummy"
      SUPABASE_URL: "https://dummy.supabase.co"
      SUPABASE_KEY: "dummy"
      MAX_COST_PER_QUERY: "0.50"
      COST_WARNING_THRESHOLD: "0.25"

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run unit tests
        run: pytest tests/unit/ --cov=src --cov-report=xml --cov-fail-under=60

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: coverage.xml
          fail_ci_if_error: false

  # Integration tests are run locally on demand (require real API keys and cost ~$0.035/run)
  # To run: pytest tests/integration/ -m integration -v
